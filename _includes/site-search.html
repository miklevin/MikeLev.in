<div id="site-search-container">
  <input type="text" id="site-search-input" placeholder="Search blog posts..." />
  <div id="site-search-results"></div>
</div>

<script>
// Load lunr.js if not already loaded
if (typeof lunr === 'undefined') {
  const loadLunr = () => {
    return new Promise((resolve, reject) => {
      const script = document.createElement('script');
      script.src = "https://unpkg.com/lunr/lunr.js";
      script.onload = resolve;
      script.onerror = reject;
      document.head.appendChild(script);
    });
  };

  (async function() {
    try {
      await loadLunr();
      initSearch();
    } catch (error) {
      console.error('Failed to load lunr.js:', error);
    }
  })();
} else {
  // lunr already loaded, initialize search
  initSearch();
}

function initSearch() {
  // Initialize search functionality
  let searchIndex, searchData;

  // Fetch the search index
  fetch('/search.json')
    .then(response => response.json())
    .then(data => {
      // Initialize lunr with data
      const idx = lunr(function() {
        this.ref('url');
        this.field('title', { boost: 10 });
        this.field('content');
        
        // Only add these fields if they exist in the data
        if (data.length > 0 && data[0].keywords) {
          this.field('keywords', { boost: 5 });
        }
        
        // Add GSC keywords with higher boost since they represent actual search behavior
        if (data.length > 0 && data[0].gsc_keywords) {
          this.field('gsc_keywords', { boost: 8 });
        }
        
        if (data.length > 0 && data[0].description) {
          this.field('description', { boost: 2 });
        }
        
        data.forEach(function(doc) {
          // Add document to the index if it has required fields
          if (doc.title && doc.url) {
            this.add(doc);
          }
        }, this);
      });
      
      // Store the index and data
      searchIndex = idx;
      searchData = data;
      
      // Set up event listener for search input
      const searchInput = document.getElementById('site-search-input');
      if (searchInput) {
        searchInput.addEventListener('keyup', performSearch);
        
        // Show/hide results container based on focus
        searchInput.addEventListener('focus', () => {
          const results = document.getElementById('site-search-results');
          if (results) {
            results.style.display = searchInput.value.trim() ? 'block' : 'none';
          }
        });
      }
    })
    .catch(error => {
      console.error('Failed to fetch search data:', error);
    });

  function performSearch() {
    const query = document.getElementById('site-search-input').value.trim();
    const resultsContainer = document.getElementById('site-search-results');
    
    if (!resultsContainer) return;
    
    if (query === '') {
      resultsContainer.style.display = 'none';
      return;
    }
    
    resultsContainer.style.display = 'block';
    
    try {
      const results = searchIndex.search(query);
      
      if (results.length === 0) {
        resultsContainer.innerHTML = '<p>No results found</p>';
        return;
      }
      
      // Show up to 20 results instead of 10
      // And no "see all results" link now
      resultsContainer.innerHTML = results
        .slice(0, 20)
        .map(result => {
          const item = searchData.find(post => post.url === result.ref);
          if (!item) return '';
          
          return `
            <div class="search-result">
              <h3><a href="${item.url}">${item.title}</a></h3>
              <p class="date">${item.date}</p>
              ${item.description ? `<p class="description">${item.description}</p>` : ''}
              ${item.keywords ? `<p class="keywords"><small>Keywords: ${item.keywords}</small></p>` : ''}
            </div>
          `;
        })
        .join('') + 
        (results.length > 20 ? '<p class="more-results">Showing 20 of ' + results.length + ' results. Refine your search for more specific results.</p>' : '');
    } catch (error) {
      console.error('Search error:', error);
      resultsContainer.innerHTML = '<p>Search error occurred. Please try a different query.</p>';
    }
  }

  // Close results when clicking outside
  document.addEventListener('click', function(event) {
    const container = document.getElementById('site-search-container');
    const input = document.getElementById('site-search-input');
    const results = document.getElementById('site-search-results');
    
    if (container && !container.contains(event.target)) {
      if (results) {
        results.style.display = 'none';
      }
    }
  });
}
</script>

<style>
  #site-search-container {
    position: sticky;
    top: 60px;
    margin: 10px 0;
    width: 100%;
    background-color: var(--background-color);
    z-index: 100;
  }
  
  #site-search-input {
    width: 100%;
    padding: 16px 20px;
    font-size: 20px;
    background-color: #1a1a1a;
    color: #ddd;
    border: 1px solid #333;
    border-radius: 4px;
    outline: none;
  }
  
  #site-search-input:focus {
    border-color: #444;
    box-shadow: 0 0 8px rgba(255, 255, 255, 0.15);
  }
  
  #site-search-results {
    display: none;
    position: absolute;
    z-index: 1000;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    background-color: #111;
    border: 1px solid #333;
    border-radius: 4px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
    margin-top: 5px;
    padding: 15px;
    color: #ddd;
  }
  
  .search-result {
    padding: 20px 15px;
    border-bottom: 1px solid #333;
    margin-bottom: 5px;
  }
  
  .search-result:last-child {
    border-bottom: none;
  }
  
  .search-result:hover {
    background-color: #1d1d1d;
  }
  
  .search-result h3 {
    margin: 0 0 12px 0;
    font-size: 28px;
    line-height: 1.3;
  }
  
  .search-result h3 a {
    color: #f0ad4e;
    text-decoration: none;
  }
  
  .search-result h3 a:hover {
    text-decoration: underline;
  }
  
  .search-result .date {
    color: #999;
    font-size: 18px;
    margin: 0 0 12px 0;
  }
  
  .search-result .description {
    margin: 15px 0 0 0;
    font-size: 20px;
    color: #bbb;
    line-height: 1.4;
  }
  
  .search-result .keywords {
    margin: 15px 0 0 0;
    color: #777;
    font-size: 16px;
  }
  
  .search-result .keywords small {
    font-size: 16px;
  }
  
  .more-results {
    text-align: center;
    margin: 15px 0 5px 0;
    font-style: italic;
    color: #999;
    font-size: 18px;
  }
  
  /* No results styling */
  #site-search-results > p {
    color: #999;
    text-align: center;
    margin: 15px 0;
    font-size: 20px;
  }
</style> 